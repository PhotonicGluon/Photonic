---
import BlogList from "@components/blog/BlogList";
import BlogPagination from "@components/blog/BlogPagination";
import ButtonLink from "@components/generic/ButtonLink.astro";

import MainLayout from "@layouts/MainLayout.astro";

import type { Post } from "@lib/blog/post";

// Get all blog posts
const allPosts: Post[] = Object.values(import.meta.glob("@blog/*.md", { eager: true }));
---

<MainLayout
    title="Blog"
    class="motion-safe:delay-200 motion-safe:duration-300 motion-safe:animate-in motion-safe:fade-in motion-safe:fill-mode-backwards motion-safe:slide-in-from-top-4"
>
    <section>
        {/* List of all posts */}
        <div class="grid gap-4 md:grid-cols-2 lg:gap-8">
            <BlogList allPosts={allPosts} client:only />
        </div>

        {/* Post-list content */}
        <div class="mt-8 w-full">
            {/* Pagination for blog posts */}
            <BlogPagination client:only />

            {/* RSS feed link */}
            <div class="float-end">
                <ButtonLink class="border hover:bg-white/15" href="/rss.xml">
                    <div class="inline-flex justify-center gap-2 align-middle">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="1.5"
                            stroke="currentColor"
                            class="size-6"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M12.75 19.5v-.75a7.5 7.5 0 0 0-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"
                            ></path>
                        </svg>
                        <span>Subscribe</span>
                    </div>
                </ButtonLink>
            </div>
        </div>
    </section>
</MainLayout>

<script>
    import { postStore } from "@components/blog/store";

    function updatePageNum() {
        const urlSearchParams = new URLSearchParams(window.location.search);
        const pageParam = urlSearchParams.get("page");
        const page = pageParam ? parseInt(pageParam) - 1 : 0; // Index, so must subtract 1
        postStore.setKey("page", page);
    }

    window.addEventListener("popstate", () => {
        window.dispatchEvent(new Event("locationchange"));
    });

    window.addEventListener("locationchange", (_) => updatePageNum());
    updatePageNum();
</script>
